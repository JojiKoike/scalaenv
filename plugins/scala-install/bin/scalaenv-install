#!/usr/bin/env bash
#
# Summary: Install a Scala/Dotty version
#
# Usage: scalaenv install <version>
#        scalaenv install -l|--list
#        scalaenv install --version
#
#   -l/--list          List all available versions
#   -s/--skip-existing Skip if the version appears to be installed already
#
# Install available Scala versions
set -e
test -n "${SCALAENV_DEBUG}" && set -x

if [ -z ${SCALAENV_ROOT} ]; then
  echo "\${SCALAENV_ROOT} is not defined." >& 2
  exit 1
fi

READLINK=$(type -p greadlink readlink | head -1)
if [ -z "${READLINK}" ]; then
  echo "scala-install: connot find readlink - are you missing GNU coreutils?" >& 2
  exit 1
fi

resolve_link() {
  ${READLINK} "${1}"
}

abs_dirname() {
  local cwd="$(pwd)"
  local path="${1}"

  while [ -n "${path}" ]; do
    cd "${path%/*}"
    local name="${path##*/}"
    path="$(resolve_link "${name}" || true)"
  done

  pwd
  cd "${cwd}"
}

SHA1SUM=$(type -p sha1sum shasum | head -1)
if [ -z "${SHA1SUM}" ]; then
  echo "scala-install: connot find sha1sum - are you missing GNU coreutils?" >& 2
  exit 1
fi

version=${1}
recipe="$(abs_dirname ${0})/../share/${version}"
if [ -f "${recipe}" ]; then
  source ${recipe}
  echo "Installing ${version}:"
  for (( i=0; i<${#sites[@]}; ++i))
  do
    if [ -d ${SCALAENV_ROOT}/versions/${version} ]; then
      echo "${version} is already installed."
      break
    fi
    mkdir -p "${SCALAENV_ROOT}/versions"
    cwd="$(pwd)"
    cd "${SCALAENV_ROOT}/versions"
    echo "Downloading ${version} archives..."
    curl -#LO "${sites[$i]}/${archive_file}"
    if [ ! -z "${sha1sum_file}" ]; then
      curl -#LO "${sites[$i]}/${sha1sum_file}"
      echo "Checking SHA-1 checksum..."
      "${SHA1SUM}" --check "${sha1sum_file}"
    fi
    if [ $? ]; then
      echo "Extracting files..."
      if [ $(echo ${SCALAENV_ROOT}/versions/${archive_file} | grep "dotty") ]; then
        tar xf "${SCALAENV_ROOT}/versions/${archive_file}" -C "${SCALAENV_ROOT}/versions"
        if [ -d ${SCALAENV_ROOT}/versions/${version}-bin-SNAPSHOT ]; then
          mv "${SCALAENV_ROOT}/versions/${version}-bin-SNAPSHOT" "${SCALAENV_ROOT}/versions/${version}"
        fi
      else
        tar xf "${SCALAENV_ROOT}/versions/${archive_file}" -C "${SCALAENV_ROOT}/versions"
      fi
      if [ $? ]; then
        rm -f "${SCALAENV_ROOT}/versions/${archive_file}"
        test ! -z "${sha1sum_file}" && rm -f "${SCALAENV_ROOT}/versions/${sha1sum_file}"
      fi
      echo "${version} installed."
      break
    fi
    cd "${cwd}"
    echo "${version} install failed."
  done
else
  echo "All available versions:"
  ls -1 $(abs_dirname $0)/../share
fi

